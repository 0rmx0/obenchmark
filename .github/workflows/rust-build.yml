# .github/workflows/rust-build.yml
# ------------------------------------------------------------
# Workflow GitHub Actions pour compiler le projet **performance_test**
# sur Ubuntu, macOS et Windows.
# ------------------------------------------------------------

name: Rust Build (Linux / macOS / Windows)

# Le workflow peut √™tre d√©clench√© manuellement ou √† chaque push sur les
# branches principales.
on:
  workflow_dispatch:          # bouton ¬´‚ÄØRun workflow‚ÄØ¬ª dans l‚Äôonglet Actions
  push:
    branches: [ main, master ]

# -----------------------------------------------------------------
# Variables communes (facultatives)
# -----------------------------------------------------------------
env:
  # Nom de l‚Äôex√©cutable produit (identique sur toutes les plateformes)
  BINARY_NAME: performance_test

# -----------------------------------------------------------------
# Jobs
# -----------------------------------------------------------------
jobs:
  # ================================================================
  # 1Ô∏è‚É£ JOB Ubuntu ‚Äì Vulkan + OpenGL
  # ================================================================
  build-ubuntu:
    name: Build (Ubuntu)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Vous pouvez ajouter d‚Äôautres combinaisons de features ici.
        features: [ "vulkan opengl" ]
    steps:
      # ---------------------------------------------------------
      # 1Ô∏è‚É£ Checkout du d√©p√¥t
      # ---------------------------------------------------------
      - name: R√©cup√©rer le code source
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2Ô∏è‚É£ Installation des d√©pendances syst√®me
      # ---------------------------------------------------------
      - name: Installer les paquets syst√®me
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libssl-dev \
            libudev-dev \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            curl

      # ---------------------------------------------------------
      # 3Ô∏è‚É£ Nettoyer un √©ventuel ancien SDK Vulkan
      # ---------------------------------------------------------
      - name: Supprimer l‚Äôancien archive du SDK Vulkan (au cas o√π)
        run: rm -f "${RUNNER_TEMP}/vulkan-sdk.tar.gz" || true

      # ---------------------------------------------------------
      # 4Ô∏è‚É£ T√©l√©charger et installer le SDK Vulkan (m√©thode robuste)
      # ---------------------------------------------------------
      - name: T√©l√©charger et installer le SDK Vulkan
        run: |
          set -euo pipefail

          VULKAN_SDK_URL="https://sdk.lunarg.com/sdk/download/latest/linux/vulkan-sdk.tar.gz"
          ARCHIVE="${RUNNER_TEMP}/vulkan-sdk.tar.gz"

          echo "üîΩ T√©l√©chargement du SDK Vulkan depuis $VULKAN_SDK_URL"
          curl -L -fSL "$VULKAN_SDK_URL" -o "$ARCHIVE"

          # V√©rifier que le fichier est bien un gzip
          if ! file "$ARCHIVE" | grep -q 'gzip compressed data'; then
            echo "‚ùå Le fichier t√©l√©charg√© n‚Äôest pas un gzip‚ÄØ!"
            echo "=== D√©but du fichier ==="
            head -n 20 "$ARCHIVE"
            echo "=== Fin du fichier ==="
            exit 1
          fi

          mkdir -p "$HOME/vulkan-sdk"
          tar -xzf "$ARCHIVE" -C "$HOME/vulkan-sdk" --strip-components=1

          # Exporter les variables d‚Äôenvironnement pour les steps suivants
          echo "VULKAN_SDK=$HOME/vulkan-sdk/x86_64" >> $GITHUB_ENV
          echo "$HOME/vulkan-sdk/x86_64/bin" >> $GITHUB_PATH

          echo "‚úÖ SDK Vulkan install√© dans $HOME/vulkan-sdk"

      # ---------------------------------------------------------
      # 5Ô∏è‚É£ Cache du registre Cargo (d√©pendances crates)
      # ---------------------------------------------------------
      - name: Cache du registre Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      # ---------------------------------------------------------
      # 6Ô∏è‚É£ Cache du r√©pertoire target (artefacts de compilation)
      # ---------------------------------------------------------
      - name: Cache du r√©pertoire target
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ matrix.features }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-${{ matrix.features }}-

      # ---------------------------------------------------------
      # 7Ô∏è‚É£ Compilation du projet (release) avec les features demand√©es
      # ---------------------------------------------------------
      - name: Compiler le projet (release)
        run: cargo build --release --features "${{ matrix.features }}"

      # ---------------------------------------------------------
      # 8Ô∏è‚É£ Archiver l‚Äôex√©cutable
      # ---------------------------------------------------------
      - name: Archiver l‚Äôex√©cutable
        if: success()
        run: |
          EXECUTABLE="target/release/${{ env.BINARY_NAME }}"
          ARCHIVE_NAME="${{ env.BINARY_NAME }}-linux.tar.gz"
          tar -czvf "$ARCHIVE_NAME" -C "$(dirname "$EXECUTABLE")" "$(basename "$EXECUTABLE")"
          echo "Archive cr√©√©e‚ÄØ: $ARCHIVE_NAME"

      # ---------------------------------------------------------
      # 9Ô∏è‚É£ Publication de l‚Äôartefact
      # ---------------------------------------------------------
      - name: Publier l‚Äôartefact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-linux
          path: ${{ env.BINARY_NAME }}-linux.tar.gz
          retention-days: 30


  # ================================================================
  # 2Ô∏è‚É£ JOB macOS ‚Äì Metal + OpenGL
  # ================================================================
  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    strategy:
      matrix:
        features: [ "metal opengl" ]
    steps:
      - name: R√©cup√©rer le code source
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2Ô∏è‚É£ Installation des d√©pendances syst√®me (Homebrew)
      # ---------------------------------------------------------
      - name: Installer les d√©pendances syst√®me
        run: |
          brew update
          brew install cmake pkg-config openssl

      # ---------------------------------------------------------
      # 3Ô∏è‚É£ Cache du registre Cargo
      # ---------------------------------------------------------
      - name: Cache du registre Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      # ---------------------------------------------------------
      # 4Ô∏è‚É£ Cache du r√©pertoire target
      # ---------------------------------------------------------
      - name: Cache du r√©pertoire target
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ matrix.features }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-${{ matrix.features }}-

      # ---------------------------------------------------------
      # 5Ô∏è‚É£ Compilation du projet (release) avec les features macOS
      # ---------------------------------------------------------
      - name: Compiler le projet (release)
        run: cargo build --release --features "${{ matrix.features }}"

      # ---------------------------------------------------------
      # 6Ô∏è‚É£ Archiver l‚Äôex√©cutable (macOS produit un binaire Unix)
      # ---------------------------------------------------------
      - name: Archiver l‚Äôex√©cutable
        if: success()
        run: |
          EXECUTABLE="target/release/${{ env.BINARY_NAME }}"
          ARCHIVE_NAME="${{ env.BINARY_NAME }}-macos.tar.gz"
          tar -czvf "$ARCHIVE_NAME" -C "$(dirname "$EXECUTABLE")" "$(basename "$EXECUTABLE")"
          echo "Archive cr√©√©e‚ÄØ: $ARCHIVE_NAME"

      # ---------------------------------------------------------
      # 7Ô∏è‚É£ Publication de l‚Äôartefact
      # ---------------------------------------------------------
      - name: Publier l‚Äôartefact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-macos
          path: ${{ env.BINARY_NAME }}-macos.tar.gz
          retention-days: 30


  # ================================================================
  # 3Ô∏è‚É£ JOB Windows ‚Äì DirectX12 + OpenGL
  # ================================================================
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    strategy:
      matrix:
        features: [ "dx12 opengl" ]
    steps:
      - name: R√©cup√©rer le code source
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2Ô∏è‚É£ Installation des d√©pendances syst√®me (Chocolatey)
      # ---------------------------------------------------------
      - name: Installer les d√©pendances syst√®me
        run: |
          choco install -y cmake pkgconfiglite openssl.light
        shell: pwsh

      # ---------------------------------------------------------
      # 3Ô∏è‚É£ Cache du registre Cargo
      # ---------------------------------------------------------
      - name: Cache du registre Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~\.cargo\registry
            ~\.cargo\git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      # ---------------------------------------------------------
      # 4Ô∏è‚É£ Cache du r√©pertoire target
      # ---------------------------------------------------------
      - name: Cache du r√©pertoire target
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ matrix.features }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-${{ matrix.features }}-

      # ---------------------------------------------------------
      # 5Ô∏è‚É£ Compilation du projet (release) avec les features Windows
      # ---------------------------------------------------------
      - name: Compiler le projet (release)
        run: cargo build --release --features "${{ matrix.features }}"

      # ---------------------------------------------------------
      # 6Ô∏è‚É£ Archiver l‚Äôex√©cutable (Windows produit un .exe)
      # ---------------------------------------------------------
      - name: Archiver l‚Äôex√©cutable
        if: success()
        run: |
          $exePath = "target\release\${{ env.BINARY_NAME }}.exe"
          $archive = "${{ env.BINARY_NAME }}-windows.zip"
          Compress-Archive -Path $exePath -DestinationPath $archive
          Write-Host "Archive cr√©√©e‚ÄØ: $archive"
        shell: pwsh

      # ---------------------------------------------------------
      # 7Ô∏è‚É£ Publication de l‚Äôartefact
      # ---------------------------------------------------------
      - name: Publier l‚Äôartefact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-windows
          path: ${{ env.BINARY_NAME }}-windows.zip
          retention-days: 30